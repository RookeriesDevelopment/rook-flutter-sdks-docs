# Rook Transmission package

This package allows apps to send health data to RookConnect servers.

## Features

* Enqueue and upload health data:
    * Sleep Summary
    * Physical Summary
    * Physical Event
    * Body Summary
    * Blood Glucose Event
    * Blood Pressure Event
    * Body Metrics Event
    * Heart Rate Event
    * Hydration Event
    * Mood Event
    * Nutrition Event
    * Oxygenation Event
    * Stress Event
    * Temperature Event

## Installation

![Pub Version](https://img.shields.io/pub/v/rook_transmission?style=for-the-badge&logo=flutter&label=pubdev&color=7200F7)

```text
flutter pub add rook_transmission
```

### Environment

This package was developed with the following sdk constraints:

* dart: ">=3.0.0 <4.0.0"
* flutter: ">=3.0.0"

### Required dependencies

To use this package you'll need to add the following dependencies to your project:

* [equatable](https://pub.dev/packages/equatable): ">=2.0.0 <3.0.0"

## Getting started

To get authorization to use this package, you'll need to install and configure
the [rook-auth](https://pub.dev/packages/rook_auth) package.

### Android configuration

In your build.gradle (app) set your min and target sdk version like below:

```groovy
minSdk 26
targetSdk 33
```

### Logging

If you want to see the logs generated by this package

Install the logging package:

```yaml
logging: ">=1.0.0 <2.0.0"
```

Add the following snippet in your `main()` function:

```dart
void main() {
  Logger.root.level = Level.ALL;
  Logger.root.onRecord.listen((record) {
    if (kDebugMode) {
      print('${record.level.name}: ${record.time}: ${record.message}');
    }
  });

  runApp(RookApp());
}
```

## Usage

Import rook_transmission:

```dart
import 'package:rook_transmission/rook_transmission.dart';
```

Create an instance of `RookTransmissionManager` providing:

* An [apiURL](https://docs.tryrook.io/docs/Definitions#api_url) without HTTPS.
* A [userID](https://docs.tryrook.io/docs/Definitions#user_id)
    * The userID must be previously registered using
      the [rook-users](https://pub.dev/packages/rook_users) package.
* A [clientUUID](https://docs.tryrook.io/docs/Definitions#client_uuid)
* A [clientPassword](https://docsbeta.tryrook.io/docs/Definitions#client_password)

```dart

final RookTransmissionManager manager = RookTransmissionManager(
  'api.rook-connect.dev',
  userID,
  clientUUID,
  clientPassword,
);
```

### Enqueueing

There are multiple functions to enqueue health data they follow the convention `enqueue_data_type`
when calling any of these functions you'll need to provide an instance of the required data type.

Enqueued data will be stored in an internal database until it is uploaded.

To enqueue a Sleep Summary call `enqueueSleepSummary` and provide an instance of `SleepSummaryItem`:

```dart
void enqueueSleep() async {
  try {
    final item = SleepSummaryItem(
      sourceOfData: 'Health Connect',
      dateTime: dateTime,
      sleepStartDatetime: startDatetime,
      sleepEndDatetime: startDatetime.add(const Duration(hours: 8)),
      sleepDate: startDatetime,
      sleepDurationSeconds: 64800,
      timeInBedSeconds: 64800,
    );

    await manager.enqueueSleepSummary(item);

    // Success
  } catch (error) {
    // Manage error
  }
}
```

Remember to send the dates and date times with UTC timezone.

rook_extraction packages like [rook_health_connect](https://pub.dev/packages/rook_health_connect)
deliver an already configured `DateTime` in those cases you don't have to do anything else.

### Clear queue

If you want to clear queued data, so it won't be sent the next time you perform an upload
call `clearQueued_data_type`:

```dart
void clearSleepSummaryQueue() async {
  try {
    await manager.clearQueuedSleepSummaries();

    // Success
  } catch (error) {
    // Manage error
  }
}
```

### Uploading

To upload (send) all enqueued health data call `upload_data_type`, this will upload the desired type of data and
delete them from the Database.

```dart
void uploadAll() async {
  try {
    await manager.uploadSleepSummaries();

    // Success
  } catch (error) {
    // Manage error
  }
}
```

### Updating user timezone

To update the timezone information of your users call `uploadUserTimeZone` and provide:

* **timezone** A tz database string describing the area and location, e.g. America/New_York.
* **offset** An integer describing the UTC offset hours, must be in the range of -18 to 18 (inclusive).

**Example using rook-health-connect**

```dart
void updateUserTimeZone() async {
  try {
    final userTimeZone = await rookHealthConnectManager.getUserTimeZone();

    await rookTransmissionManager.uploadUserTimeZone(
      userTimeZone.timezone,
      userTimeZone.offset,
    );

    // Success
  } catch (error) {
    // Manage error
  }
}
```

## Other resources

* See a complete list of `RookTransmissionManager` methods in
  the [API Reference](https://pub.dev/documentation/rook_transmission/latest/rook_transmission/RookTransmissionManager-class.html)